
<div class="hero-unit" id="stat_panel">

  <div class="row-fluid" id="alert_field">
  </div>

  <div class="form-horizontal">
      <div class="control-group">
          <label class="control-label" for="ksPath">Key chain media:</label>
            <div class="controls">
                <div id="ksPathLabel"></div>
                <select class="input-xlarge" id="ksPath">
                    <option value="INVALID">Not found</option>
                </select>
            </div>
      </div>

      <div class="control-group">
          <label class="control-label" for="serv_status">Service status:</label>
            <div class="controls">
                <div id="serv_status"></div>
            </div>
      </div>

      <div class="control-group">
          <label class="control-label" for="sync_status">Synchronization status:</label>
            <div class="controls">
                <div id="sync_status"></div>
            </div>
      </div>

      <div class="control-group">
            <div class="controls">
                <a id="startstop"></a>
            </div>
      </div>
  </div>

</div>

<div id="pwdModal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Please, enter pin-code for key chain</h3>
    </div>
    <div class="modal-body">
        <input id="pwdEdit" type="password"/>
    </div>
  <div class="modal-footer">
      <a onclick="start_service();" class="btn btn-success">Start</a>
    </div>
</div>

<div id="spinModal" class="modal hide fade">
    <div class="modal-header">
        <h3>Processing request...</h3>
    </div>
    <div class="modal-body text-center">
        <img class="" src="/static/img/wait.gif"/>
    </div>
</div>


<SCRIPT type="text/javascript">
    $.fn.hasAttr = function(name) {  
           return this.attr(name) !== undefined;
    }

    function show_alert(msg) {
        html ='<div class="alert alert-error">'+
          '<button type="button" class="close" data-dismiss="alert">&times;</button>'+
          '<h4>Error!</h4>'+
          '<span id="err_msg"/>'+
        '</div>';
        $('#alert_field').html(html);
        $('#err_msg').html(mkbr(msg));
    }

    function start_service() {
        if ($('#startstop').hasAttr('disabled')) {return;}

        var pwd=$('#pwdEdit').val();

        $('#alert_field').html('');
        if (pwd) {
            $('#pwdEdit').val('');    
            $('#pwdModal').modal('hide');
            $('#spinModal').modal();

            $.post("/start_service", { 
                    '__key_storage': $('#ksPath').val(),
                    'password': pwd },
                    function(data) {
                        if (data['ret_code'] == 0) {
                            reload_content();
                        } else {
                            show_alert(data['ret_message']);
                        }
                        $('#spinModal').modal('hide');
                    }
            ).fail(
                function() { 
                    show_alert('Internal server error...');
                    $('#spinModal').modal('hide');
                }        
            ); 

        } else {
            $('#pwdModal').modal();        
            $('#pwdEdit').focus();
        }
    }

    function stop_service() {
        if ($('#startstop').hasAttr('disabled')) {return;}

        $('#spinModal').modal();
        $.post("/stop_service",
                function(data) {
                    if (data['ret_code'] == 0) {
                        reload_content();
                    } else {
                        show_alert(data['ret_message']);
                    }

                    $('#spinModal').modal('hide');
                    $('#pwdModal').modal('hide');
                }
        ).fail(
            function() { 
                show_alert('Internal server error...');
                $('#spinModal').modal('hide');
            }        
        ); 
    }

    function start_stop_service() {
        if ($('#startstop').hasClass("btn-danger")) {
            stop_service();
        } else {
            start_service();
        }
    }

    function update_label(label_id, label_type, text) {
        if ($(label_id).hasClass(label_type) && ($(label_id).html() == text)) {
            return;
        }
        var bcl;
        if (label_type.indexOf('label') == -1) {
            bcl = 'btn btn-large';
        } else {
            bcl = 'label';
        }
        $(label_id).attr('class', bcl).addClass(label_type).html(text);
    }

    $.global_vars = { 
            last_available_ks : [] 
    }; 

    function is_equal_arrays(array_obj) {
       if ($.global_vars.last_available_ks.length != array_obj.length) {return false;}
       for (var i=0; i<array_obj.length; i++) {
           for (var j=0; j<3; j++) {
                if (array_obj[i][j] != $.global_vars.last_available_ks[i][j]) {return false;}
           }
       }
       return true;
    }

    function reload_content(){
        var SS_ALL_SYNC = 0,
            SS_SYNC_PENDING = 1;

        $.getJSON('/get_media_devices', function(data) {
            if (is_equal_arrays(data['__available_ks_list'])) {
                return;
           }
           $.global_vars.last_available_ks = data['__available_ks_list'];
           $('#ksPath').html('');
           for (var i=0; i<data['__available_ks_list'].length; i++) {
               if (data['__available_ks_list'][i][2]) {
                $('#ksPath').append('<option value="'+data['__available_ks_list'][i][1]+'">'+data['__available_ks_list'][i][0]+'</option>');
               }
           }
           if ($('#ksPath').html() == '') {
             $('#startstop').attr('disabled', 'disabled');
             $('#ksPath').hide();
             $('#ksPathLabel').show();
             update_label('#ksPathLabel', 'label-important', 'Not found');
           } else {
             $('#startstop').removeAttr('disabled');
             if ($('#ksPath').children().length > 1) {
                $('#ksPathLabel').hide();
                $('#ksPath').show();
             } else {
                $('#ksPath').hide();
                $('#ksPathLabel').show();
                update_label('#ksPathLabel', 'label', $('#ksPath').children().first().html());
             }
           }
        });

        $.getJSON('/get_service_status', function(data) {
            if (data['service_status'] == 'started') {
                update_label('#serv_status', 'label-success', 'Started');
                update_label('#startstop', 'btn-danger', 'Stop service');
                $('#ksPath').attr('disabled', 'disabled');
            } else {
                update_label('#serv_status', 'label-important', 'Stopped');
                update_label('#startstop', 'btn-success', 'Start service');
                $('#ksPath').removeAttr('disabled');
            }

            if (data['sync_status'] == SS_ALL_SYNC) {
                update_label('#sync_status', 'label-success', 'All files are synchronized');
            } else if (data['sync_status'] == SS_SYNC_PENDING) {
                update_label('#sync_status', 'label-warning', 'Some files are not synchronized yet');
            } else {
                update_label('#sync_status', 'label-warning', 'Unknown');
            }
        }).fail(function() {
            update_label('#sync_status', 'label-warning', 'Unknown');
            update_label('#serv_status', 'label-warning', 'Unknown');
        });
    }

    $(function () { 
        $('#ksPath').hide();
        $('#ksPathLabel').css('display', 'inline');
        $('#ksPathLabel').hide();
        $('#wind').stopTime();
        $('#wind').everyTime(5000, reload_content);
        $('#startstop').click(start_stop_service);
        $('#pwdEdit').keypress(function (e) {
            if (e.which == 13) {
              start_service();
            }
        });
        $('#pwdModal').on('hide', function () {
            $('#pwdEdit').val('');    
        });

        reload_content();
    });
</SCRIPT>
