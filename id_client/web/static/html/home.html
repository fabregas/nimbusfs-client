
<div class="hero-unit" id="stat_panel">

<div class="row-fluid" id="alert_field">
</div>

<div class="row-fluid">
    <div class="span4 text-right" ><h4>Key chain status:</h4></div>
    <div class="span8"><h4 id="ks_status"></h4></div>
</div>

<div class="row-fluid">
    <div class="span4 text-right" ><h4>Service status:</h4></div>
    <div class="span8"><h4 id="serv_status"></h4></div>
</div>
<div class="row-fluid">
    <div class="span4 text-right" ><h4>Synchronization status:</h4></div>
    <div class="span8"><h4 id="sync_status"></h4></div>
</div>

<div class="row-fluid">
    <div class="span4 text-right" ></div>
    <div class="span8"><a id="startstop"></a></div>
</div>
</div>

<div id="pwdModal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Please, enter pin-code for key chain</h3>
    </div>
    <div class="modal-body">
        <input id="pwdEdit" type="password"/>
    </div>
  <div class="modal-footer">
      <a onclick="start_service();" class="btn btn-success">Start</a>
    </div>
</div>

<div id="spinModal" class="modal hide fade">
    <div class="modal-header">
        <h3>Processing request...</h3>
    </div>
    <div class="modal-body text-center">
        <img class="" src="/static/img/wait.gif"/>
    </div>
</div>


<SCRIPT type="text/javascript">
    function show_alert(msg) {
        html ='<div class="alert alert-error">'+
          '<button type="button" class="close" data-dismiss="alert">&times;</button>'+
          '<h4>Error!</h4>'+
          '<span id="err_msg"/>'+
        '</div>';
        $('#alert_field').html(html);
        $('#err_msg').html(msg);
    }

    function start_service() {
        if ($('#startstop').hasClass('disabled')) {return;}

        var pwd=$('#pwdEdit').val();

        $('#alert_field').html('');
        if (pwd) {
            $('#pwdEdit').val('');    
            $('#pwdModal').modal('hide');
            $('#spinModal').modal();

            $.post("/start_service", { password: pwd },
                    function(data) {
                        if (data['ret_code'] == 0) {
                            reload_content();
                        } else {
                            show_alert(data['ret_message']);
                        }
                        $('#spinModal').modal('hide');
                    }
            ).fail(
                function() { 
                    show_alert('Internal server error...');
                    $('#spinModal').modal('hide');
                }        
            ); 

        } else {
            $('#pwdModal').modal();        
            $('#pwdEdit').focus();
        }
    }

    function stop_service() {
        if ($('#startstop').hasClass('disabled')) {return;}

        $('#spinModal').modal();
        $.post("/stop_service",
                function(data) {
                    if (data['ret_code'] == 0) {
                        reload_content();
                    } else {
                        show_alert(data['ret_message']);
                    }

                    $('#spinModal').modal('hide');
                    $('#pwdModal').modal('hide');
                }
        ).fail(
            function() { 
                show_alert('Internal server error...');
                $('#spinModal').modal('hide');
            }        
        ); 
    }

    function start_stop_service() {
        if ($('#startstop').hasClass("btn-danger")) {
            stop_service();
        } else {
            start_service();
        }
    }

    function update_label(label_id, label_type, text) {
        if ($(label_id).hasClass(label_type) && ($(label_id).html() == text)) {
            return;
        }
        var bcl;
        if (label_type.indexOf('label') == -1) {
            bcl = 'btn btn-large';
        } else {
            bcl = 'label';
        }
        $(label_id).attr('class', bcl).addClass(label_type).html(text);
    }

    function reload_content(){
        var SS_ALL_SYNC = 0,
            SS_SYNC_PENDING = 1;

        $.getJSON('/get_service_status', function(data) {
            if (data['service_status'] == 'started') {
                update_label('#serv_status', 'label-success', 'Started');
                update_label('#startstop', 'btn-danger', 'Stop service');
            } else {
                update_label('#serv_status', 'label-important', 'Stopped');
                update_label('#startstop', 'btn-success', 'Start service');
            }

            if (data['sync_status'] == SS_ALL_SYNC) {
                update_label('#sync_status', 'label-success', 'All files are synchronized');
            } else if (data['sync_status'] == SS_SYNC_PENDING) {
                update_label('#sync_status', 'label-warning', 'Some files are not synchronized yet');
            } else {
                update_label('#sync_status', 'label-warning', 'Unknown');
            }

            if (data['has_keystorage'] == 1) {
                update_label('#ks_status', 'label-success', 'Inserted');
                if ($('#startstop').hasClass('disabled')) { 
                    $('#startstop').removeClass('disabled');
                }
            } else {
                if (data['has_keystorage'] == 0) {
                    update_label('#ks_status', 'label-important', 'Absent');
                } else {
                    update_label('#ks_status', 'label-important', 'Invalid');
                }
                if (! $('#startstop').hasClass('disabled')) { 
                    $('#startstop').addClass('disabled');
                }
            }
        }).fail(function() {
            update_label('#sync_status', 'label-warning', 'Unknown');
            update_label('#ks_status', 'label-warning', 'Unknown');
            update_label('#serv_status', 'label-warning', 'Unknown');
        });
    }

    $(function () { 
        $('#wind').everyTime(5000, reload_content);
        $('#startstop').click(start_stop_service);
        $('#pwdEdit').keypress(function (e) {
            if (e.which == 13) {
              start_service();
            }
        });
        $('#pwdModal').on('hide', function () {
            $('#pwdEdit').val('');    
        });

        reload_content();
    });
</SCRIPT>
