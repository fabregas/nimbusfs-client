
<div class="hero-unit">
    <form class="form-horizontal">

      <div class="control-group">
        <label class="control-label" for="ksPath">Key storage</label>
        <div class="controls">
            <select class="input-xlarge" id="ksPath">
            </select>
        </div>
      </div>

      <div class="control-group">
        <label class="control-label" for="serviceURL">Service URL</label>
        <div class="controls">
          <input class="input-xlarge" type="text" id="serviceURL">
        </div>
      </div>
      <div class="control-group">
          <label class="control-label" for="parDownCnt">Parallel downloads count</label>
            <div class="controls">
              <input type="number" max="10" min="1" id="parDownCnt">
            </div>
      </div>
      <div class="control-group">
          <label class="control-label" for="parUpCnt">Parallel uploads count</label>
            <div class="controls">
              <input type="number" max="10" min="1" id="parUpCnt">
            </div>
      </div>
      <hr>

      <div class="control-group">
        <label class="control-label" for="mountType">Mount type</label>
        <div class="controls">
            <select class="input-xlarge" id="mountType">
                <option value="local">Local mount</option>
                <option value="export">Export WebDav</option>
            </select>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="webdavHost">WebDav hostname</label>
        <div class="controls">
          <input class="input-xlarge" type="text" id="webdavHost">
        </div>
      </div>
      <div class="control-group">
          <label class="control-label" for="webdavPort">WebDav port</label>
            <div class="controls">
              <input type="number" max="64000" min="1" id="webdavPort">
            </div>
      </div>
      <hr>

      <div class="control-group">
        <div class="controls">
          <button type="submit" id="apply_btn" class="btn span4">Apply</button>
        </div>
      </div>
    </form>
</div>

<SCRIPT type="text/javascript">
    function on_mount_type_change() {
        if ($('#mountType').val() == 'local') {
            $('#webdavHost').attr('disabled', 'disabled');
        } else {
            $('#webdavHost').removeAttr('disabled');
        }
        allow_applying();
    }

    function allow_applying() {
        $('#apply_btn').removeAttr('disabled');
    }
    $(function () {
        $('input').change(allow_applying);
        $('#ksPath').change(allow_applying);
        $('#mountType').change(on_mount_type_change);
        $.getJSON('/get_settings', function(data) {
           $('#ksPath').html('');
           if (data['__has_ks'] != 1) {
             $('#ksPath').append('<option value="INVALID">Not found</option>');
           }
           for (var i=0; i<data['__available_ks_list'].length; i++) {
               if (data['__available_ks_list'][i][2]) {
                $('#ksPath').append('<option value="'+data['__available_ks_list'][i][1]+'">'+data['__available_ks_list'][i][0]+'</option>');
               }
           }
           $('#serviceURL').val(data['fabnet_hostname']); 
           $('#webdavHost').val(data['webdav_bind_host']); 
           $('#webdavPort').val(data['webdav_bind_port']); 
           $('#parDownCnt').val(data['parallel_get_count']); 
           $('#parUpCnt').val(data['parallel_put_count']); 
           $('#mountType option[value="'+data['mount_type']+'"]').attr('selected', 'selected');
           on_mount_type_change();
           $('#apply_btn').attr('disabled', 'disabled');
        });
    });
    $('form').submit(function() {
        var ksPath = $('#ksPath').val();
        if (ksPath == 'INVALID') {
            $('#err_msg').remove();
            $('#apply_btn').before('<div id="err_msg"></div>');
            var close_btn = '<button type="button" class="close" data-dismiss="alert">×</button>';
            $('#err_msg').attr('class', 'alert alert-error').html(close_btn+'<strong>ERROR!</strong> Please, select key storage!');
            return false;
        }
        $.post('/apply_settings', 
            {'__key_storage': ksPath,
            'fabnet_hostname': $('#serviceURL').val(),
            'webdav_bind_host': $('#webdavHost').val(),
            'webdav_bind_port': $('#webdavPort').val(),
            'parallel_get_count': $('#parDownCnt').val(),
            'parallel_put_count': $('#parUpCnt').val(),
            'mount_type': $('#mountType').val() 
            },            
            function(html) {
                $('#err_msg').remove();
                $('#apply_btn').before('<div id="err_msg"></div>');
                var close_btn = '<button type="button" class="close" data-dismiss="alert">×</button>';
                if (html['ret_code'] == 0) {
                    $('#err_msg').html('');
                    $('#err_msg').attr('class', 'alert alert-success').html(close_btn+'<strong>Done!</strong> Settings are applied!');
                    $('#apply_btn').attr('disabled', 'disabled');
                } else {
                    $('#err_msg').attr('class', 'alert alert-error').html(close_btn+'<strong>ERROR!</strong> '+html['ret_message']+'');
                }
            });
        return false;
    });
</SCRIPT>
